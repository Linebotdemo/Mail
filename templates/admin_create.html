<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>管理者アカウント作成＋企業一覧</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container mt-5">

  <div id="password-section">
    <h3>🔐 アクセスパスワードを入力してください</h3>
    <input type="password" id="access-password" class="form-control mb-2" placeholder="パスワードを入力">
    <button class="btn btn-primary" onclick="verifyPassword()">確認</button>
    <div id="auth-error" class="text-danger mt-2"></div>
  </div>

  <div id="main-content" class="hidden" style="display:none;">
    <h2>👤 管理者アカウント作成</h2>
    <form id="admin-form" class="mt-4">
      <div class="mb-3">
        <label class="form-label">メールアドレス</label>
        <input type="email" name="email" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">パスワード</label>
        <input type="password" name="password" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">企業名</label>
        <input type="text" name="company_name" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary">管理者を作成</button>
    </form>
    <div id="result" class="mt-3"></div>

    <hr class="my-5">
    <h3>🏢 登録されている企業一覧</h3>
    <table class="table table-bordered mt-3">
      <thead>
        <tr>
          <th>ID</th>
          <th>企業名</th>
          <th>従業員数</th>
          <th>管理者メール</th>
        </tr>
      </thead>
      <tbody id="company-list">
        <tr><td colspan="4">読み込み中...</td></tr>
      </tbody>
    </table>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    let SERVER_PASSWORD = "";

    // ✅ .envの値を取得して格納
    $.get('/api/get_admin_key', function(res) {
      SERVER_PASSWORD = res.key;
    });

    function verifyPassword() {
      const input = document.getElementById('access-password').value;
      if (input === SERVER_PASSWORD) {
        $('#password-section').hide();
        $('#main-content').fadeIn();
        loadCompanies();
      } else {
        $('#auth-error').text('パスワードが正しくありません');
      }
    }

$('#admin-form').on('submit', function(e) {
  e.preventDefault();
  const formData = {
    email: $('input[name="email"]').val(),
    password: $('input[name="password"]').val(),
    company_name: $('input[name="company_name"]').val()
  };

  console.log("📦 送信データ: ", formData);  // ← 追加

  $.ajax({
    url: '/api/create_admin',
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(formData),
    success: res => {
      $('#result').html('<div class="alert alert-success">' + res.message + '</div>');
      loadCompanies();
    },
    error: xhr => {
      const msg = xhr.responseJSON?.message || '作成に失敗しました';
      $('#result').html('<div class="alert alert-danger">' + msg + '</div>');
    }
  });
});


    function loadCompanies() {
      $.get('/api/companies', function (companies) {
        const rows = (companies || []).map(c => `
          <tr>
            <td>${c.id}</td>
            <td>${c.company_name}</td>
            <td>${c.employee_count}</td>
            <td>${c.admin_email || '未設定'}</td>
          </tr>
        `);
        $('#company-list').html(rows.join('') || '<tr><td colspan="4">データなし</td></tr>');
      }).fail(() => {
        $('#company-list').html('<tr><td colspan="4">読み込み失敗</td></tr>');
      });
    }
  </script>
</body>
</html>
