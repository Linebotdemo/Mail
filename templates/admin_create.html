<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆï¼‹ä¼æ¥­ä¸€è¦§</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container mt-5">

  <div id="password-section">
    <h3>ğŸ” ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h3>
    <input type="password" id="access-password" class="form-control mb-2" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
    <button class="btn btn-primary" onclick="verifyPassword()">ç¢ºèª</button>
    <div id="auth-error" class="text-danger mt-2"></div>
  </div>

  <div id="main-content" class="hidden" style="display:none;">
    <h2>ğŸ‘¤ ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</h2>
    <form id="admin-form" class="mt-4">
      <div class="mb-3">
        <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" name="email" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" name="password" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">ä¼æ¥­å</label>
        <input type="text" name="company_name" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary">ç®¡ç†è€…ã‚’ä½œæˆ</button>
    </form>
    <div id="result" class="mt-3"></div>

    <hr class="my-5">
    <h3>ğŸ¢ ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ä¼æ¥­ä¸€è¦§</h3>
    <table class="table table-bordered mt-3">
      <thead>
        <tr>
          <th>ID</th>
          <th>ä¼æ¥­å</th>
          <th>å¾“æ¥­å“¡æ•°</th>
          <th>ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«</th>
        </tr>
      </thead>
      <tbody id="company-list">
        <tr><td colspan="4">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
      </tbody>
    </table>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    let SERVER_PASSWORD = "";

    // âœ… .envã®å€¤ã‚’å–å¾—ã—ã¦æ ¼ç´
    $.get('/api/get_admin_key', function(res) {
      SERVER_PASSWORD = res.key;
    });

    function verifyPassword() {
      const input = document.getElementById('access-password').value;
      if (input === SERVER_PASSWORD) {
        $('#password-section').hide();
        $('#main-content').fadeIn();
        loadCompanies();
      } else {
        $('#auth-error').text('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
      }
    }

$('#admin-form').on('submit', function(e) {
  e.preventDefault();
  const formData = {
    email: $('input[name="email"]').val(),
    password: $('input[name="password"]').val(),
    company_name: $('input[name="company_name"]').val()
  };

  console.log("ğŸ“¦ é€ä¿¡ãƒ‡ãƒ¼ã‚¿: ", formData);  // â† è¿½åŠ 

  $.ajax({
    url: '/api/create_admin',
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(formData),
    success: res => {
      $('#result').html('<div class="alert alert-success">' + res.message + '</div>');
      loadCompanies();
    },
    error: xhr => {
      const msg = xhr.responseJSON?.message || 'ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
      $('#result').html('<div class="alert alert-danger">' + msg + '</div>');
    }
  });
});


    function loadCompanies() {
      $.get('/api/companies', function (companies) {
        const rows = (companies || []).map(c => `
          <tr>
            <td>${c.id}</td>
            <td>${c.company_name}</td>
            <td>${c.employee_count}</td>
            <td>${c.admin_email || 'æœªè¨­å®š'}</td>
          </tr>
        `);
        $('#company-list').html(rows.join('') || '<tr><td colspan="4">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>');
      }).fail(() => {
        $('#company-list').html('<tr><td colspan="4">èª­ã¿è¾¼ã¿å¤±æ•—</td></tr>');
      });
    }
  </script>
</body>
</html>
