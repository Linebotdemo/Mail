<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆï¼‹ä¼æ¥­ä¸€è¦§</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container mt-5">

  <div id="password-section">
    <h3>ğŸ” ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h3>
    <input type="password" id="access-password" class="form-control mb-2" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
    <button class="btn btn-primary" onclick="verifyPassword()">ç¢ºèª</button>
    <div id="auth-error" class="text-danger mt-2"></div>
  </div>

  <div id="main-content" class="hidden" style="display:none;">
    <h2>ğŸ‘¤ ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</h2>
    <form id="admin-form" class="mt-4">
      <div class="mb-3">
        <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" name="email" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" name="password" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">ä¼æ¥­å</label>
        <input type="text" name="company_name" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary">ç®¡ç†è€…ã‚’ä½œæˆ</button>
    </form>
    <div id="result" class="mt-3"></div>

    <hr class="my-5">

    <!-- ã‚¿ãƒ–ãƒŠãƒ“ -->
    <ul class="nav nav-tabs" id="dataTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="companies-tab" data-bs-toggle="tab" data-bs-target="#companies" type="button" role="tab">ğŸ¢ ç™»éŒ²ä¼æ¥­ä¸€è¦§</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="received-tab" data-bs-toggle="tab" data-bs-target="#received" type="button" role="tab">ğŸ“¥ å—ä¿¡ãƒ‡ãƒ¼ã‚¿ç¢ºèª</button>
      </li>
    </ul>

    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="tab-content mt-3">
      <!-- ä¼æ¥­ä¸€è¦§ -->
      <div class="tab-pane fade show active" id="companies" role="tabpanel">
        <table class="table table-bordered">
<thead>
  <tr>
    <th>ID</th>
    <th>ä¼æ¥­å</th>
    <th>å¾“æ¥­å“¡æ•°</th>
    <th>ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«</th>
    <th>æ“ä½œ</th>
  </tr>
</thead>

<tbody id="company-list">
  <tr><td colspan="4">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
</tbody>

        </table>
      </div>
      <!-- å—ä¿¡ãƒ‡ãƒ¼ã‚¿ -->
      <div class="tab-pane fade" id="received" role="tabpanel">
        <table class="table table-bordered">
<thead>
  <tr>
    <th>åå‰</th>
    <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
    <th>ãŠå•ã„åˆã‚ã›å†…å®¹</th>
    <th>å—ä»˜æ—¥æ™‚</th>
  </tr>
</thead>

          <tbody id="received-data">
            <tr><td colspan="2">ã¾ã é€ä¿¡ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    console.log('[startup] script load');

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let SERVER_PASSWORD = "";

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°: ä¼æ¥­ä¸€è¦§å–å¾—
function loadCompanies() {
  console.log('[loadCompanies] called');
  $.get('/api/companies')
    .done(function(companies) {
      console.log('[loadCompanies] response:', companies);
      const rows = (companies || []).map(c => `
        <tr>
          <td>${c.id}</td>
          <td>${c.company_name}</td>
          <td>${c.employee_count}</td>
          <td>${c.admin_email || 'æœªè¨­å®š'}</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="blockUser(${c.admin_id})">ãƒ–ãƒ­ãƒƒã‚¯</button>
            <button class="btn btn-sm btn-success" onclick="unblockUser(${c.admin_id})">è§£é™¤</button>
          </td>
        </tr>
      `);
      $('#company-list').html(
        rows.join('') || '<tr><td colspan="5">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>'
      );
    })
    .fail(function() {
      console.error('[loadCompanies] failed');
      $('#company-list').html('<tr><td colspan="5">èª­ã¿è¾¼ã¿å¤±æ•—</td></tr>');
    });
}

function blockUser(userId) {
  if (!userId) {
    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒä¸æ­£ã§ã™');
    return;
  }
  $.post(`/api/users/${userId}/block`)
    .done(res => {
      alert(res.message);
      loadCompanies();
    })
    .fail(() => {
      alert('ãƒ–ãƒ­ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

function unblockUser(userId) {
  if (!userId) {
    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒä¸æ­£ã§ã™');
    return;
  }
  $.post(`/api/users/${userId}/unblock`)
    .done(res => {
      alert(res.message);
      loadCompanies();
    })
    .fail(() => {
      alert('è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}



function loadInquiries() {
  console.log('[loadInquiries] called');
  $.get('/api/inquiries')
    .done(function(res) {
      console.log('[loadInquiries] response:', res);
      if (res.success && Array.isArray(res.inquiries)) {
        const rows = res.inquiries.map(q => `
          <tr>
            <td>${q.name}</td>
            <td>${q.email}</td>
            <td>${q.message}</td>
            <td>${q.created_at}</td>
          </tr>
        `);
        $('#received-data').html(
          rows.join('') || '<tr><td colspan="4">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>'
        );
      } else {
        $('#received-data').html(
          `<tr><td colspan="4">${res.message || 'ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—'}</td></tr>`
        );
      }
    })
    .fail(function(xhr) {
      console.error('[loadInquiries] failed', xhr);
      $('#received-data').html('<tr><td colspan="4">èª­ã¿è¾¼ã¿å¤±æ•—</td></tr>');
    });
}




    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
    function verifyPassword() {
      const input = $('#access-password').val();
      console.log('[verifyPassword] called, input:', input, 'vs SERVER_PASSWORD:', SERVER_PASSWORD);
      if (input === SERVER_PASSWORD) {
        console.log('[verifyPassword] success');
        $('#password-section').hide();
        $('#main-content').fadeIn();
        loadCompanies();  // ã“ã‚Œã§ä¼šç¤¾ä¸€è¦§ã‚‚æ›´æ–°
      } else {
        console.warn('[verifyPassword] invalid password');
        $('#auth-error').text('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
      }
    }

    // .env ã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼å´ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—
    console.log('[startup] fetching admin key...');
    $.get('/api/get_admin_key')
      .done(function(res) {
        SERVER_PASSWORD = res.key;
        console.log('[startup] SERVER_PASSWORD set:', SERVER_PASSWORD);
      })
      .fail(function() {
        console.error('[startup] failed to fetch admin key');
      });

    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ¬ãƒ‡ã‚£
    $(function() {
      console.log('[startup] document ready');

      // åˆå›è¡¨ç¤ºæ™‚ã«ä¼æ¥­ä¸€è¦§ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœªå…¥åŠ›ã§ã‚‚è¦‹ãˆã‚‹ã‚ˆã†ã«ï¼‰
      loadCompanies();

  $('#received-tab').on('click', function() {
    loadInquiries();
  });

      // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒãƒ³ãƒ‰ãƒ©
      $('#admin-form').on('submit', function(e) {
        e.preventDefault();
        const formData = {
          email:        $('input[name="email"]').val(),
          password:     $('input[name="password"]').val(),
          company_name: $('input[name="company_name"]').val()
        };
        console.log('[#admin-form] submit, formData:', formData);

        $.ajax({
          url: '/api/create_admin',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(formData)
        })
        .done(function(res) {
          console.log('[#admin-form] success response:', res);
          $('#result').html(`<div class="alert alert-success">${res.message}</div>`);
          loadCompanies();
          updateReceivedData(formData);
        })
        .fail(function(xhr) {
          console.error('[#admin-form] error response:', xhr);
          const msg = xhr.responseJSON?.message || 'ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
          $('#result').html(`<div class="alert alert-danger">${msg}</div>`);
        });
      });
    });
  </script>
</body>
</html>
